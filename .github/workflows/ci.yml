name: CI

on:
  push:
    branches: ["**"]
    paths-ignore:
      - ".github/**"
      - "assets/**"
      - "examples/**"
  pull_request:
    paths-ignore:
      - ".github/**"
      - "assets/**"
      - "examples/**"
  workflow_dispatch:

jobs:
  pre-commit:
    name: Pre-commit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
          global-json-file: global.json

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: precommit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks
        run: pre-commit run --all-files

      - name: Export pre-commit metrics
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p metrics/ci
          cat > metrics/ci/pre-commit.json <<EOF
          {
            "workflow": "CI",
            "job": "pre-commit",
            "status": "${{ job.status }}"
          }
          EOF

      - name: Upload pre-commit metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-metrics-pre-commit
          path: metrics/ci/pre-commit.json

  build-test:
    needs: pre-commit
    name: Build and test (${{ matrix.os }}, .NET ${{ matrix.dotnet }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        dotnet: ["10.0.x"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet }}
          cache: true
          global-json-file: global.json
          cache-dependency-path: |
            **/*.slnx
            **/*.csproj
            **/packages.lock.json

      - name: Build
        run: dotnet build Workbench.slnx

      - name: Test (unit)
        run: dotnet test --project tests/Workbench.Tests/Workbench.Tests.csproj --logger "trx;LogFileName=unit-${{ matrix.os }}.trx" --results-directory "artifacts/test-results/${{ matrix.os }}"

      - name: Test (integration)
        run: dotnet test --project tests/Workbench.IntegrationTests/Workbench.IntegrationTests.csproj --logger "trx;LogFileName=integration-${{ matrix.os }}.trx" --results-directory "artifacts/test-results/${{ matrix.os }}"

      - name: Export matrix metrics
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p metrics/ci
          cat > metrics/ci/build-test-${{ matrix.os }}.json <<EOF
          {
            "workflow": "CI",
            "job": "build-test",
            "os": "${{ matrix.os }}",
            "dotnet": "${{ matrix.dotnet }}",
            "status": "${{ job.status }}"
          }
          EOF

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-test-results-${{ matrix.os }}
          path: artifacts/test-results/${{ matrix.os }}/*.trx
          if-no-files-found: ignore

      - name: Upload matrix metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-metrics-${{ matrix.os }}
          path: metrics/ci/build-test-${{ matrix.os }}.json

  report:
    name: CI report
    runs-on: ubuntu-latest
    if: always()
    needs: [pre-commit, build-test]
    steps:
      - name: Download all workflow artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Write CI quality summary
        shell: bash
        run: |
          set -euo pipefail
          source scripts/ci/reporting.sh

          precommit_result="${{ needs.pre-commit.result }}"
          build_result="${{ needs.build-test.result }}"

          overall="âœ… Passed"
          if [[ "$precommit_result" != "success" || "$build_result" != "success" ]]; then
            overall="âŒ Failed"
          fi

          precommit_status="âœ…"
          [[ "$precommit_result" != "success" ]] && precommit_status="âŒ"

          build_status="âœ…"
          [[ "$build_result" != "success" ]] && build_status="âŒ"

          eval "$(bash scripts/ci/parse-trx.sh artifacts)"

          tests_status="âŒ"
          tests_metric="Metrics missing"
          tests_threshold="0 fails"
          tests_notes="No TRX artifacts found"

          if [[ "$reports" -gt 0 ]]; then
            tests_metric="${passed} pass / ${failed} fail / ${skipped} skipped"
            tests_notes="${reports} report(s)"
            if [[ "$failed" -eq 0 ]]; then
              tests_status="âœ…"
            fi
          fi

          {
            echo "# CI Quality Summary"
            echo ""
            echo "**Workflow:** ${{ github.workflow }}"
            echo "**Ref:** ${{ github.ref_name }}"
            echo "**Commit:** ${{ github.sha }}"
            echo "**Trigger:** ${{ github.event_name }}"
            echo "**Result:** $overall"
            echo ""
            echo "## Executive Gates"
            echo "| Gate | Status | Metric | Threshold | Notes |"
            echo "|---|---|---:|---:|---|"
            echo "| Build | $build_status | Matrix build-test: $build_result | Success | ubuntu/windows/macos |"
            echo "| ðŸ§ª Tests | $tests_status | $tests_metric | $tests_threshold | $tests_notes |"
            echo "| ðŸ“Š Coverage | N/A | Not run in this workflow | n/a | Use Quality Gate workflow |"
            echo "| ðŸŒ€ Fuzzing | N/A | Not configured | n/a | n/a |"
            echo "| ðŸ§¬ Mutation | N/A | Not run in this workflow | n/a | Use Mutation workflow |"
            echo "| ðŸ“¦ Packaging | N/A | Not run in this workflow | n/a | Use Quality/Publish workflows |"
            echo "| ðŸ“ Pre-commit | $precommit_status | $precommit_result | Success | Hook validation |"
            echo ""
            echo "## Artifacts"
            echo "- ci-test-results-<os>"
            echo "- ci-metrics-pre-commit"
            echo "- ci-metrics-<os>"
          } >> "$GITHUB_STEP_SUMMARY"

          if [[ "$overall" != "âœ… Passed" ]]; then
            {
              echo ""
              echo "## ðŸ“ Action Required"
              echo "- Open failing jobs in this run and start with the first non-success gate row above."
              echo "- Use TRX artifacts to inspect failing tests and stack traces."
            } >> "$GITHUB_STEP_SUMMARY"
          fi
