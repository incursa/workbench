name: Publish NuGet package

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set-up dotnet
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json
          dotnet-version: 10.0.x
          cache: true
          cache-dependency-path: |
            **/*.slnx
            **/*.csproj
            **/packages.lock.json

      - name: Cache NuGet
        uses: actions/cache@v5
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Install PowerShell
        uses: PSModule/install-powershell@v1

      - name: Determine Version
        id: git_version
        shell: pwsh
        run: |
          $now = [System.DateTime]::UtcNow
          $revision = $now.Hour * 60 + $now.Minute
          $baseVersion = "$($now.Year).$($now.Month).$($now.Day).$revision"
          $version = $baseVersion

          try {
            $branchName = (git rev-parse --abbrev-ref HEAD).Trim()
            Write-Host "Branch name: $branchName"
            $mainBranches = @("main", "master")

            if ($branchName -and ($mainBranches -notcontains $branchName.ToLowerInvariant())) {
              # Sanitize branch name for pre-release tag
              $safeBranch = $branchName -replace '[^A-Za-z0-9-]', '-'
              $version = "$baseVersion-$safeBranch"
            }
          } catch {
            Write-Warning "Could not determine git branch. Using base version."
          }

          Write-Host "Calculated Version: $version"
          echo "semVer=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Restore
        run: dotnet restore Workbench.slnx

      - name: Pack
        run: dotnet pack src/Workbench/Workbench.csproj -c Release -o ./artifacts -p:PackageVersion=${{ steps.git_version.outputs.semVer }}

      - name: Publish
        run: dotnet nuget push "artifacts/*.nupkg" --api-key "${{ secrets.NUGET_API_KEY }}" --source "https://api.nuget.org/v3/index.json" --skip-duplicate
