name: Workbench Item Generate

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "AI prompt describing the work item"
        required: true
        type: string
      type:
        description: "Work item type (bug, task, spike)"
        required: false
        type: string
      status:
        description: "Work item status (draft, ready, in-progress, blocked, done, dropped)"
        required: false
        type: string
      priority:
        description: "Work item priority (low, medium, high, critical)"
        required: false
        type: string
      owner:
        description: "Owner for the work item"
        required: false
        type: string
      model:
        description: "AI model override (optional)"
        required: false
        type: string
      provider:
        description: "AI provider (openai or none)"
        required: false
        default: "openai"
        type: string

permissions:
  contents: read

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Workbench CLI tool
        run: |
          dotnet tool install --global Incursa.Workbench
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Generate work item
        id: generate_item
        env:
          WORKBENCH_AI_PROVIDER: ${{ inputs.provider }}
          WORKBENCH_AI_WORK_ITEM_MODEL: ${{ inputs.model }}
          WORKBENCH_AI_OPENAI_KEY: ${{ secrets.WORKBENCH_AI_OPENAI_KEY || secrets.OPENAI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || secrets.WORKBENCH_AI_OPENAI_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts/workbench
          args=(item generate --prompt "${{ inputs.prompt }}")

          if [[ -n "${{ inputs.type }}" ]]; then
            args+=(--type "${{ inputs.type }}")
          fi

          if [[ -n "${{ inputs.status }}" ]]; then
            args+=(--status "${{ inputs.status }}")
          fi

          if [[ -n "${{ inputs.priority }}" ]]; then
            args+=(--priority "${{ inputs.priority }}")
          fi

          if [[ -n "${{ inputs.owner }}" ]]; then
            args+=(--owner "${{ inputs.owner }}")
          fi

          workbench "${args[@]}" 2>&1 | tee artifacts/workbench/item-generate.log

      - name: Export workflow metrics
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p metrics/workbench
          cat > metrics/workbench/item-generate.json <<EOF
          {
            "workflow": "Workbench Item Generate",
            "job": "generate",
            "status": "${{ job.status }}",
            "provider": "${{ inputs.provider }}",
            "type": "${{ inputs.type }}",
            "priority": "${{ inputs.priority }}",
            "owner": "${{ inputs.owner }}",
            "generate_outcome": "${{ steps.generate_item.outcome }}"
          }
          EOF

      - name: Upload operational artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workbench-item-generate-artifacts
          path: |
            artifacts/workbench/item-generate.log
            metrics/workbench/item-generate.json
          if-no-files-found: ignore

      - name: Write workflow summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          overall="âœ… Passed"
          generate_status="âœ…"
          if [[ "${{ steps.generate_item.outcome }}" != "success" ]]; then
            overall="âŒ Failed"
            generate_status="âŒ"
          fi

          {
            echo "# CI Quality Summary"
            echo ""
            echo "**Workflow:** ${{ github.workflow }}"
            echo "**Ref:** ${{ github.ref_name }}"
            echo "**Commit:** ${{ github.sha }}"
            echo "**Trigger:** ${{ github.event_name }}"
            echo "**Result:** $overall"
            echo ""
            echo "## Executive Gates"
            echo "| Gate | Status | Metric | Threshold | Notes |"
            echo "|---|---|---:|---:|---|"
            echo "| Operational: Item Generation | $generate_status | Provider: ${{ inputs.provider }} | Command succeeds | Type=${{ inputs.type }}, Priority=${{ inputs.priority }} |"
            echo "| ðŸ§ª Tests | N/A | Not run in this workflow | n/a | n/a |"
            echo "| ðŸ“Š Coverage | N/A | Not run in this workflow | n/a | n/a |"
            echo "| ðŸŒ€ Fuzzing | N/A | Not configured | n/a | n/a |"
            echo "| ðŸ§¬ Mutation | N/A | Not run in this workflow | n/a | n/a |"
            echo "| ðŸ“¦ Packaging | N/A | Not run in this workflow | n/a | n/a |"
            echo ""
            echo "## Artifacts"
            echo "- workbench-item-generate-artifacts"
          } >> "$GITHUB_STEP_SUMMARY"

          if [[ "$overall" != "âœ… Passed" ]]; then
            {
              echo ""
              echo "## ðŸ“ Action Required"
              echo "- Inspect `workbench-item-generate-artifacts` and open `item-generate.log` first."
            } >> "$GITHUB_STEP_SUMMARY"
          fi
