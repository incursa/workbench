name: Mutation (Critical Surface)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1"

jobs:
  mutation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Install Stryker
        run: dotnet tool install --global dotnet-stryker --version 4.*

      - name: Run mutation tests
        id: mutation_run
        run: dotnet stryker --config-file stryker-config.json --reporter json

      - name: Collect mutation metrics
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Path metrics/mutation -Force | Out-Null

          $threshold = (Get-Content stryker-config.json -Raw | ConvertFrom-Json)."stryker-config".thresholds.break
          $reportPath = Get-ChildItem -Path StrykerOutput -Recurse -File -Filter mutation-report.json -ErrorAction SilentlyContinue | Select-Object -First 1

          $score = $null
          $killed = $null
          $survived = $null
          $noCoverage = $null
          $timedOut = $null

          if ($reportPath) {
            $report = Get-Content $reportPath.FullName -Raw | ConvertFrom-Json
            if ($report.files) {
              $allMutants = @()
              foreach ($file in $report.files.PSObject.Properties) {
                $allMutants += $file.Value.mutants
              }
              $killed = ($allMutants | Where-Object { $_.status -eq "Killed" }).Count
              $survived = ($allMutants | Where-Object { $_.status -eq "Survived" }).Count
              $noCoverage = ($allMutants | Where-Object { $_.status -eq "NoCoverage" }).Count
              $timedOut = ($allMutants | Where-Object { $_.status -eq "Timeout" }).Count
              $denominator = $allMutants.Count - $noCoverage
              if ($denominator -gt 0) {
                $score = [Math]::Round((($killed + $timedOut) * 100.0) / $denominator, 2)
              }
            }
          }

          $mutationStatus = "‚ùå"
          if ($score -ne $null -and $score -ge $threshold) {
            $mutationStatus = "‚úÖ"
          }

          $payload = [ordered]@{
            workflow = "Mutation (Critical Surface)"
            job = "mutation"
            status = "${{ job.status }}"
            mutation = [ordered]@{
              status = $mutationStatus
              score = $score
              threshold = $threshold
              killed = $killed
              survived = $survived
              noCoverage = $noCoverage
              timedOut = $timedOut
              reportFound = [bool]$reportPath
            }
          }

          $payload | ConvertTo-Json -Depth 8 | Set-Content -Path metrics/mutation/mutation-metrics.json
          [ordered]@{
            mutation_score = $score
          } | ConvertTo-Json -Depth 4 | Set-Content -Path metrics/mutation/mutation-baseline.json

      - name: Upload mutation metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-metrics
          path: metrics/mutation/mutation-metrics.json

      - name: Upload mutation baseline
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-baseline
          path: metrics/mutation/mutation-baseline.json

      - name: Download baseline snapshot from main
        if: always()
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: mutation-critical.yml
          workflow_conclusion: success
          branch: main
          name: mutation-baseline
          path: artifacts/baseline
          if_no_artifact_found: warn

      - name: Upload mutation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: |
            StrykerOutput/**

      - name: Write mutation summary
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $metrics = Get-Content metrics/mutation/mutation-metrics.json -Raw | ConvertFrom-Json

          $overall = if ("${{ job.status }}" -eq "success") { "‚úÖ Passed" } else { "‚ùå Failed" }
          $scoreText = if ($metrics.mutation.score -ne $null) { "{0:N2}%" -f $metrics.mutation.score } else { "‚ùå Metrics missing" }
          $thresholdText = if ($metrics.mutation.threshold -ne $null) { ">= $($metrics.mutation.threshold)%" } else { "n/a" }
          $mutationStatus = $metrics.mutation.status
          $baselinePath = Get-ChildItem -Path artifacts/baseline -Recurse -File -Filter mutation-baseline.json -ErrorAction SilentlyContinue | Select-Object -First 1
          $deltaText = "n/a"
          if ($baselinePath -and $metrics.mutation.score -ne $null) {
            $baseline = Get-Content $baselinePath.FullName -Raw | ConvertFrom-Json
            if ($baseline.mutation_score -ne $null -and "$($baseline.mutation_score)" -ne "") {
              $delta = [Math]::Round(([double]$metrics.mutation.score - [double]$baseline.mutation_score), 2)
              $deltaText = "{0:+0.00;-0.00;0.00}% vs main" -f $delta
            }
          }
          $notes = if ($metrics.mutation.reportFound) { "$deltaText; Killed $($metrics.mutation.killed); Survived $($metrics.mutation.survived); NoCoverage $($metrics.mutation.noCoverage); Timeout $($metrics.mutation.timedOut)" } else { "‚ùå mutation-report.json not found" }
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "# CI Quality Summary"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Workflow:** ${{ github.workflow }}"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Ref:** ${{ github.ref_name }}"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Commit:** ${{ github.sha }}"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Trigger:** ${{ github.event_name }}"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Result:** $overall"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Executive Gates"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "| Gate | Status | Metric | Threshold | Notes |"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "|---|---|---:|---:|---|"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "| Build | N/A | Not run in this workflow | n/a | n/a |"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "| üß™ Tests | N/A | Not run in this workflow | n/a | n/a |"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "| üìä Coverage | N/A | Not run in this workflow | n/a | n/a |"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "| üåÄ Fuzzing | N/A | Not configured | n/a | n/a |"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "| üß¨ Mutation | $mutationStatus | $scoreText | $thresholdText | $notes |"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "| üì¶ Packaging | N/A | Not run in this workflow | n/a | n/a |"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Artifacts"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- mutation-report"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- mutation-metrics"

          if ("${{ job.status }}" -ne "success") {
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## üìù Action Required"
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- Open the `mutation-report` artifact and inspect surviving or no-coverage mutants."
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- Prioritize critical-file survivors first."
          }
