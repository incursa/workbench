name: Workbench Promote and Start

on:
  workflow_dispatch:
    inputs:
      id:
        description: "Work item ID (e.g., TASK-0042)"
        required: true
        type: string
      base:
        description: "Base branch to promote from (optional)"
        required: false
        type: string
      start:
        description: "Mark the work item in-progress"
        required: false
        default: true
        type: boolean
      push:
        description: "Push the promoted branch to origin"
        required: false
        default: true
        type: boolean
      create_pr:
        description: "Create a draft PR after promotion"
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Workbench CLI tool
        run: |
          dotnet tool install --global Incursa.Workbench
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Configure GitHub provider
        env:
          GITHUB_TOKEN: ${{ secrets.WORKBENCH_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          WORKBENCH_GITHUB_TOKEN: ${{ secrets.WORKBENCH_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          workbench config set --path github.provider --value octokit

      - name: Promote work item
        id: promote_item
        env:
          GITHUB_TOKEN: ${{ secrets.WORKBENCH_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          WORKBENCH_GITHUB_TOKEN: ${{ secrets.WORKBENCH_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          function Invoke-Logged {
            param(
              [Parameter(Mandatory = $true)]
              [string]$FilePath,
              [string[]]$Arguments = @()
            )
            $joinedArgs = ($Arguments | ForEach-Object { if ($_ -match "\s") { '"' + $_ + '"' } else { $_ } }) -join " "
            Write-Host ">> $FilePath $joinedArgs"
            $output = & $FilePath @Arguments 2>&1 | Tee-Object -Variable commandOutput
            $exitCode = $LASTEXITCODE
            if ($exitCode -ne 0) {
              Write-Host $commandOutput
              throw "Command failed with exit code ${exitCode}: $FilePath $joinedArgs"
            }
            return $output
          }

          $itemId = "${{ inputs.id }}"
          $baseBranch = "${{ inputs.base }}"
          $startItem = "${{ inputs.start }}"
          $pushBranch = "${{ inputs.push }}"
          $createPr = "${{ inputs.create_pr }}"
          New-Item -ItemType Directory -Path artifacts/workbench -Force | Out-Null
          Start-Transcript -Path artifacts/workbench/promote.log -Force | Out-Null

          $itemJson = (Invoke-Logged -FilePath "workbench" -Arguments @("--format", "json", "item", "show", $itemId) | Out-String) | ConvertFrom-Json
          $configJson = (Invoke-Logged -FilePath "workbench" -Arguments @("--format", "json", "config", "show") | Out-String) | ConvertFrom-Json

          if (-not [string]::IsNullOrWhiteSpace($baseBranch)) {
            Invoke-Logged -FilePath "git" -Arguments @("checkout", $baseBranch)
          }

          $item = $itemJson.data.item
          $branchPattern = $configJson.data.config.git.branchPattern
          $commitPattern = $configJson.data.config.git.commitMessagePattern
          if ([string]::IsNullOrWhiteSpace($branchPattern)) {
            $branchPattern = "work/{id}-{slug}"
          }
          if ([string]::IsNullOrWhiteSpace($commitPattern)) {
            $commitPattern = "Promote {id}: {title}"
          }

          $branchName = $branchPattern.Replace("{id}", $item.id).Replace("{slug}", $item.slug).Replace("{title}", $item.title)
          $commitMessage = $commitPattern.Replace("{id}", $item.id).Replace("{slug}", $item.slug).Replace("{title}", $item.title)
          "itemId=$itemId" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "branchName=$branchName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          Invoke-Logged -FilePath "git" -Arguments @("checkout", "-b", $branchName)

          if ($startItem -eq "true") {
            Invoke-Logged -FilePath "workbench" -Arguments @("item", "status", $item.id, "in-progress")
            Invoke-Logged -FilePath "git" -Arguments @("add", $item.path)
            "started=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            "started=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

          & git diff --cached --quiet
          $hasStagedChanges = ($LASTEXITCODE -ne 0)
          if ($hasStagedChanges) {
            Invoke-Logged -FilePath "git" -Arguments @("commit", "-m", $commitMessage)
            "committed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } elseif ($createPr -eq "true") {
            Invoke-Logged -FilePath "git" -Arguments @("commit", "--allow-empty", "-m", $commitMessage)
            "committed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            "committed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

          if ($pushBranch -eq "true" -or $createPr -eq "true") {
            Invoke-Logged -FilePath "git" -Arguments @("push", "-u", "origin", $branchName)
            "pushed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            "pushed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

          if ($createPr -eq "true") {
            $prArgs = @("github", "pr", "create", $item.id, "--draft", "--fill")
            if (-not [string]::IsNullOrWhiteSpace($baseBranch)) {
              $prArgs += @("--base", $baseBranch)
            }
            Invoke-Logged -FilePath "workbench" -Arguments $prArgs
            "prCreated=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            "prCreated=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

          Invoke-Logged -FilePath "workbench" -Arguments @("item", "sync", "--id", $item.id)
          Stop-Transcript | Out-Null

      - name: Export workflow metrics
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p metrics/workbench
          cat > metrics/workbench/promote.json <<EOF
          {
            "workflow": "Workbench Promote and Start",
            "job": "promote",
            "status": "${{ job.status }}",
            "item_id": "${{ steps.promote_item.outputs.itemId }}",
            "branch_name": "${{ steps.promote_item.outputs.branchName }}",
            "started": "${{ steps.promote_item.outputs.started }}",
            "committed": "${{ steps.promote_item.outputs.committed }}",
            "pushed": "${{ steps.promote_item.outputs.pushed }}",
            "pr_created": "${{ steps.promote_item.outputs.prCreated }}"
          }
          EOF

      - name: Upload operational artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workbench-promote-artifacts
          path: |
            artifacts/workbench/promote.log
            metrics/workbench/promote.json
          if-no-files-found: ignore

      - name: Write workflow summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          overall="âœ… Passed"
          promote_status="âœ…"
          if [[ "${{ steps.promote_item.outcome }}" != "success" ]]; then
            overall="âŒ Failed"
            promote_status="âŒ"
          fi

          {
            echo "# CI Quality Summary"
            echo ""
            echo "**Workflow:** ${{ github.workflow }}"
            echo "**Ref:** ${{ github.ref_name }}"
            echo "**Commit:** ${{ github.sha }}"
            echo "**Trigger:** ${{ github.event_name }}"
            echo "**Result:** $overall"
            echo ""
            echo "## Executive Gates"
            echo "| Gate | Status | Metric | Threshold | Notes |"
            echo "|---|---|---:|---:|---|"
            echo "| Operational: Promote/Start | $promote_status | Item `${{ inputs.id }}` | Command succeeds | Branch `${{ steps.promote_item.outputs.branchName }}` |"
            echo "| ðŸ§ª Tests | N/A | Not run in this workflow | n/a | n/a |"
            echo "| ðŸ“Š Coverage | N/A | Not run in this workflow | n/a | n/a |"
            echo "| ðŸŒ€ Fuzzing | N/A | Not configured | n/a | n/a |"
            echo "| ðŸ§¬ Mutation | N/A | Not run in this workflow | n/a | n/a |"
            echo "| ðŸ“¦ Packaging | N/A | Not run in this workflow | n/a | n/a |"
            echo ""
            echo "## Artifacts"
            echo "- workbench-promote-artifacts"
          } >> "$GITHUB_STEP_SUMMARY"

          if [[ "$overall" != "âœ… Passed" ]]; then
            {
              echo ""
              echo "## ðŸ“ Action Required"
              echo "- Inspect `workbench-promote-artifacts` and open `promote.log` for the first failing command."
            } >> "$GITHUB_STEP_SUMMARY"
          fi
