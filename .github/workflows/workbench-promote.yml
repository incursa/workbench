name: Workbench Promote and Start

on:
  workflow_dispatch:
    inputs:
      id:
        description: "Work item ID (e.g., TASK-0042)"
        required: true
        type: string
      base:
        description: "Base branch to promote from (optional)"
        required: false
        type: string
      start:
        description: "Mark the work item in-progress"
        required: false
        default: true
        type: boolean
      push:
        description: "Push the promoted branch to origin"
        required: false
        default: true
        type: boolean
      create_pr:
        description: "Create a draft PR after promotion"
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Workbench CLI tool
        run: |
          dotnet tool install --global Incursa.Workbench
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Configure GitHub provider
        env:
          GITHUB_TOKEN: ${{ secrets.WORKBENCH_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          WORKBENCH_GITHUB_TOKEN: ${{ secrets.WORKBENCH_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          workbench config set --path github.provider --value octokit

      - name: Promote work item
        env:
          GITHUB_TOKEN: ${{ secrets.WORKBENCH_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          WORKBENCH_GITHUB_TOKEN: ${{ secrets.WORKBENCH_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          function Invoke-Logged {
            param(
              [Parameter(Mandatory = $true)]
              [string]$FilePath,
              [string[]]$Arguments = @()
            )
            $joinedArgs = ($Arguments | ForEach-Object { if ($_ -match "\s") { '"' + $_ + '"' } else { $_ } }) -join " "
            Write-Host ">> $FilePath $joinedArgs"
            $output = & $FilePath @Arguments 2>&1 | Tee-Object -Variable commandOutput
            $exitCode = $LASTEXITCODE
            if ($exitCode -ne 0) {
              Write-Host $commandOutput
              throw "Command failed with exit code ${exitCode}: $FilePath $joinedArgs"
            }
            return $output
          }

          $itemId = "${{ inputs.id }}"
          $baseBranch = "${{ inputs.base }}"
          $startItem = "${{ inputs.start }}"
          $pushBranch = "${{ inputs.push }}"
          $createPr = "${{ inputs.create_pr }}"

          $itemJson = (Invoke-Logged -FilePath "workbench" -Arguments @("--format", "json", "item", "show", $itemId) | Out-String) | ConvertFrom-Json
          $configJson = (Invoke-Logged -FilePath "workbench" -Arguments @("--format", "json", "config", "show") | Out-String) | ConvertFrom-Json

          if (-not [string]::IsNullOrWhiteSpace($baseBranch)) {
            Invoke-Logged -FilePath "git" -Arguments @("checkout", $baseBranch)
          }

          $item = $itemJson.data.item
          $branchPattern = $configJson.data.config.git.branchPattern
          $commitPattern = $configJson.data.config.git.commitMessagePattern
          if ([string]::IsNullOrWhiteSpace($branchPattern)) {
            $branchPattern = "work/{id}-{slug}"
          }
          if ([string]::IsNullOrWhiteSpace($commitPattern)) {
            $commitPattern = "Promote {id}: {title}"
          }

          $branchName = $branchPattern.Replace("{id}", $item.id).Replace("{slug}", $item.slug).Replace("{title}", $item.title)
          $commitMessage = $commitPattern.Replace("{id}", $item.id).Replace("{slug}", $item.slug).Replace("{title}", $item.title)

          Invoke-Logged -FilePath "git" -Arguments @("checkout", "-b", $branchName)

          if ($startItem -eq "true") {
            Invoke-Logged -FilePath "workbench" -Arguments @("item", "status", $item.id, "in-progress")
            Invoke-Logged -FilePath "git" -Arguments @("add", $item.path)
          }

          & git diff --cached --quiet
          $hasStagedChanges = ($LASTEXITCODE -ne 0)
          if ($hasStagedChanges) {
            Invoke-Logged -FilePath "git" -Arguments @("commit", "-m", $commitMessage)
          } elseif ($createPr -eq "true") {
            Invoke-Logged -FilePath "git" -Arguments @("commit", "--allow-empty", "-m", $commitMessage)
          }

          if ($pushBranch -eq "true" -or $createPr -eq "true") {
            Invoke-Logged -FilePath "git" -Arguments @("push", "-u", "origin", $branchName)
          }

          if ($createPr -eq "true") {
            $prArgs = @("github", "pr", "create", $item.id, "--draft", "--fill")
            if (-not [string]::IsNullOrWhiteSpace($baseBranch)) {
              $prArgs += @("--base", $baseBranch)
            }
            Invoke-Logged -FilePath "workbench" -Arguments $prArgs
          }

          Invoke-Logged -FilePath "workbench" -Arguments @("item", "sync", "--id", $item.id)
