name: Workbench Promote and Start

on:
  workflow_dispatch:
    inputs:
      id:
        description: "Work item ID (e.g., TASK-0042)"
        required: true
        type: string
      base:
        description: "Base branch to promote from (optional)"
        required: false
        type: string
      start:
        description: "Mark the work item in-progress"
        required: false
        default: true
        type: boolean
      push:
        description: "Push the promoted branch to origin"
        required: false
        default: true
        type: boolean
      create_pr:
        description: "Create a draft PR after promotion"
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Workbench CLI tool
        run: |
          dotnet tool install --global Bravellian.Workbench
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Configure GitHub provider
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKBENCH_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          workbench config set --path github.provider --value octokit

      - name: Promote work item
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKBENCH_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          item_json=$(workbench --format json item show "${{ inputs.id }}")
          config_json=$(workbench --format json config show)

          if [[ -n "${{ inputs.base }}" ]]; then
            git checkout "${{ inputs.base }}"
          fi

          item_id=$(echo "$item_json" | jq -r '.data.item.id')
          item_title=$(echo "$item_json" | jq -r '.data.item.title')
          item_slug=$(echo "$item_json" | jq -r '.data.item.slug')
          item_path=$(echo "$item_json" | jq -r '.data.item.path')
          branch_pattern=$(echo "$config_json" | jq -r '.data.config.git.branchPattern')
          commit_pattern=$(echo "$config_json" | jq -r '.data.config.git.commitMessagePattern')

          branch_name="${branch_pattern//\{id\}/$item_id}"
          branch_name="${branch_name//\{slug\}/$item_slug}"
          branch_name="${branch_name//\{title\}/$item_title}"

          commit_message="${commit_pattern//\{id\}/$item_id}"
          commit_message="${commit_message//\{slug\}/$item_slug}"
          commit_message="${commit_message//\{title\}/$item_title}"

          git checkout -b "$branch_name"

          if [[ "${{ inputs.start }}" == "true" ]]; then
            workbench item status "$item_id" in-progress
            git add "$item_path"
          fi

          if git diff --cached --quiet; then
            if [[ "${{ inputs.create_pr }}" == "true" ]]; then
              git commit --allow-empty -m "$commit_message"
            fi
          else
            git commit -m "$commit_message"
          fi

          if [[ "${{ inputs.push }}" == "true" || "${{ inputs.create_pr }}" == "true" ]]; then
            git push -u origin "$branch_name"
          fi

          if [[ "${{ inputs.create_pr }}" == "true" ]]; then
            pr_args=(github pr create "$item_id" --draft --fill)
            if [[ -n "${{ inputs.base }}" ]]; then
              pr_args+=(--base "${{ inputs.base }}")
            fi
            workbench "${pr_args[@]}"
          fi

          workbench item sync --id "$item_id"
          fi
