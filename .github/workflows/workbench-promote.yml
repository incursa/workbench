name: Workbench Promote and Start

on:
  workflow_dispatch:
    inputs:
      type:
        description: "Work item type (bug, task, spike)"
        required: true
        type: string
      title:
        description: "Work item title"
        required: true
        type: string
      base:
        description: "Base branch to promote from (optional)"
        required: false
        type: string
      start:
        description: "Mark the work item in-progress"
        required: false
        default: true
        type: boolean
      push:
        description: "Push the promoted branch to origin"
        required: false
        default: true
        type: boolean
      create_pr:
        description: "Create a draft PR after promotion"
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Workbench CLI tool
        run: |
          dotnet tool install --global Bravellian.Workbench
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Configure GitHub provider
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKBENCH_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          workbench config set --path github.provider --value octokit

      - name: Promote work item
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKBENCH_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          args=(promote --type "${{ inputs.type }}" --title "${{ inputs.title }}")

          if [[ -n "${{ inputs.base }}" ]]; then
            args+=(--base "${{ inputs.base }}")
          fi

          if [[ "${{ inputs.start }}" == "true" ]]; then
            args+=(--start)
          fi

          if [[ "${{ inputs.push }}" == "true" ]]; then
            args+=(--push)
          fi

          if [[ "${{ inputs.create_pr }}" == "true" ]]; then
            args+=(--pr --draft)
          fi
          promote_output=$(workbench --format json "${args[@]}")
          echo "$promote_output"
          item_id=$(echo "$promote_output" | jq -r '.data.item.id // empty')

          if [[ -n "$item_id" ]]; then
            workbench item sync --id "$item_id"
          fi
